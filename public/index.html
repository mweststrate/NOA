<!DOCTYPE HTML>
<html>
  <head>
    <title>Noa WS test</title>
	<script src='noa/noa.js' ></script>
    <script src="scripts/jquery-1.9.1.min.js" ></script >
    <!--
    <script src="/socket.io/socket.io.js" />
	<script>

	var socket = io.connect('http://localhost');

	socket.on('news', function (data) {
		console.log(data);
		socket.emit('my other event', { my: 'data' });
	});

	</script>-->


<script type="text/javascript">

jQuery(function($) {
	NOA.require("NOA.core","NOA.util", function() {

		NOA.declare("NOA.ui.CellRenderer", NOA.core.Base, {
			cell : null,
			node : null,
			input : null,

			init : function(parentNode, cell) {
				this.cell = cell.live();
				this.node = $("<div class='noa-cell'></div>").data('widget', this).appendTo(parentNode);
				this.input = $("<input></input>").appendTo(this.node);
				this.input.on('change', $.proxy(this.onInput, this)); //TODO: off in destructor

				this.renderValue(cell.get(this, this.renderValue)); //Render and listen
			},

			renderValue : function(newvalue) {
				this.input.prop('value', newvalue);
			},

			onInput : function() {
				this.cell.set(this.input.prop('value')) //Note, fires back to renderValue
			},

			free : function() {
				this.cell.die();
				this.node.remove();
			}
		})

		NOA.declare("NOA.ui.RecordRenderer", NOA.core.Base, {

			record : null, 
			node : null,
			table : null,

			init : function(parentNode, record) {
				this.record = record.live();
				this.node = $("<div class='noa-record'></div>").data('widget', this).appendTo(parentNode);
				this.table = $("<table></table>").appendTo(this.node);
				this.newKeyInput = $("<input class='record-new-key'></input>")
					.appendTo(this.node)
					.on('change', $.proxy(this.onNewKey, this)) //TODO off() in free.

				var keys = record.keys.toArray();
				NOA.each(keys, function(key, i) {
					this.renderKeyValue(i, key)
				}, this)
				
				this.listenTo(record.keys, 'insert', function(index, newkey) {
					//create a new row somewhere in the middle? (add is done by renderKeyValue automatically)
					if (index < this.getRowCount()) 
						this.createRow().insertBefore(".noa-key-row:eq(" + index + ")", this.table);

					this.renderKeyValue(index, newkey);
				});

				this.listenTo(record.keys, 'remove', function(index) {
					//TODO: cleanup sub widgets?
					this.getRow(index).remove();
				});

				this.listenTo(record.keys, 'move', function(from, to) {
					var rto = move > to ? to : to - 1;
					var row = this.getRow(from);

					//move within dom
					row.detach().insertBefore(this.getRow(rto))
				});

				//NOTE: list.set is never triggered for record.keys
			},

			onNewKey : function() {
				var val = this.newKeyInput.prop('value');
				if (val != '') {
					this.record.set(val, ''); //TODO: get focus there..
					this.newKeyInput.prop('value', '');
				}
			},

			getRow : function(index) {
				return $(".noa-key-row:eq(" + index + ")", this.table);
			},

			getRowCount : function() {
				return this.table.prop('rows').length;
			},

			createRow : function() {
				return $("<tr class='noa-key-row'><td class='noa-key'></td><td class='noa-value'></td></tr>")
			},

			renderKeyValue : function(pos, key) {
				if (pos > this.getRowCount())
					throw "out of bounds!"

				var row;
				if (pos == this.getRowCount()) 
					row = this.createRow().appendTo(this.table);
				else
					row = this.getRow(pos);
				
				$(".noa-key", row).text(key);
				render($(".noa-value", row), this.record.cell(key));

			},

			free : function() {
				this.record.die();
				this.node.remove();
			}

		});


		var rootRecord = new NOA.Record();

		rootRecord.set("hello", "world");
		rootRecord.set("koffie", "bar");

		render($(document.body), rootRecord);

		rootRecord.set("foo", "bar");
		rootRecord.set("hello", "the universe!");

		rootRecord.remove("koffie");

		function render(node, value) {
			//TODO: clean up any existing widget for node

			if (NOA.Record.isA(value)) 
				new NOA.ui.RecordRenderer(node, value);

			else if (NOA.core.Cell.isA(value))
				new NOA.ui.CellRenderer(node, value);

			else
				node.text(value);
		}

	})
})
</script>
  </head>
  <body>
  </body>
</html>